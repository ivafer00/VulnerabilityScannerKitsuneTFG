<!DOCTYPE html>
<html>
    <head>

        <meta charset="UTF-8">
        <title>Kitsune</title>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">

        <script src="./js/graph_cytoscape_utils.js"></script>
        <script src="./js/form_report.js"></script>
        <script src="./js/vulnerability_report.js"></script>
    <!--    <script src="./js/sse.js"></script>-->
        <link rel="stylesheet" href="./css/style.css">

    </head>
    <body>
        <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
            <a class="navbar-brand" href="#">
                <img src="/images/icon.png" alt="logo" style="height:50px;">
            </a>
            <ul class="nav navbar-nav nav-tabs text-white">
                <li class="nav-item">
                    <a class="nav-link active text-white bg-dark" data-toggle="tab" href="#HOME">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white bg-dark" data-toggle="tab" href="#GRAPHS">Modelo de la aplicación</a>
                </li>
                {{#xssScan}}
                <li class="nav-item">
                    <a class="nav-link text-white bg-dark" data-toggle="tab" href="#XSS">XSS</a>
                </li>
                {{/xssScan}}
                {{#sqlInjectionScan}}
                <li class="nav-item">
                    <a class="nav-link text-white bg-dark" data-toggle="tab" href="#SQLi">SQL Injection</a>
                </li>
                {{/sqlInjectionScan}}
                {{#csrfScan}}
                <li class="nav-item">
                    <a class="nav-link text-white bg-dark" data-toggle="tab" href="#CSRF">CSRF</a>
                </li>
                {{/csrfScan}}
                {{#noSecureChannel}}
                <li class="nav-item">
                    <a class="nav-link text-white bg-dark" data-toggle="tab" href="#NSC">No Secure Channel</a>
                </li>
                {{/noSecureChannel}}
                {{#improperErrorHandling}}
                <li class="nav-item">
                    <a class="nav-link text-white bg-dark" data-toggle="tab" href="#IEH">Improper Error Handling</a>
                </li>
                {{/improperErrorHandling}}
                {{#staticAnalysis}}
                <li class="nav-item">
                    <a class="nav-link text-white bg-dark" data-toggle="tab" href="#SA">Análisis estático</a>
                </li>
                {{/staticAnalysis}}
                <li class="nav-item">
                    <a class="nav-link text-white bg-dark" href="/scan_configurer">Volver a la página inicial</a>
                </li>
            </ul>
        </nav>

        <div class="tab-content">

            <div class="tab-pane container active" id="HOME">
                <br>
                <div class="container bg-info text-white">
                    <h1>Bienvenido al escáner de vulnerabilidades.</h1>
                    <p>URL: {{initialUrl}}</p>
                    <p>URLBase: {{baseUrl}}</p>
                    {{#hasCredentials}}
                    <p>Escáner con credenciales ({{user}})</p>
                    {{/hasCredentials}}
                    {{^hasCredentials}}
                    <p>Escáner sin credenciales</p>
                    {{/hasCredentials}}
                </div>
                <br>
                <div class="container">
                    <div class="progress-container">
                        <div class="progress" id="progress"> </div>
                        <div class="circle">Precontrato</div>
                        <div class="circle">Enlazando la web</div>
                        <div class="circle">Explotación</div>
                        <div class="circle">Vulnerabilidades almacenadas</div>
                        {{#hasCredentials}}
                            <div class="circle">Autenticación</div>
                        {{/hasCredentials}}
                        <div class="circle">Reporte completo</div>
                    </div>
                </div>
                <script src="./js/progress.js"></script>
            </div>

            <div class="tab-pane fade" id="GRAPHS">
                <button class="btn btn-primary active" id="unauth" onclick="showWebGraph(this)">Modelo no autenticado</button>
                <button class="btn btn-secondary" id="auth" onclick="showWebGraph(this)">Modelo autenticado</button><br>
                <div id="graph_unauth" class="float-left" style="height: 500px; width:100%; border:1px solid black;"></div>
                <div id="graph_auth" class="float-left" style="height: 500px; width:100%; border:1px solid black;"></div>

                <div id="accordion_unauth"></div>
                <div id="accordion_auth"></div>
            </div>

            <div class="tab-pane container fade" id="XSS">

            </div>

            <div class="tab-pane container fade" id="SQLi">

            </div>

            <div class="tab-pane container fade" id="CSRF">

            </div>

            <div class="tab-pane fade" id="NSC"></div>

            <div class="tab-pane fade" id="IEH"></div>

            <div class="tab-pane fade" id="SA">
                {{#APIMethods}}
                <div class="container bg-info text-white" id="APIMethods">
                    <h2>Todos los métodos de la API</h2>
                    <p>Estado: <span id="APIMethodsStatus">Pendiente</span></p>
                    <ul id="APIMethodsContext" style="padding-left: 5%"></ul>
                </div>
                {{/APIMethods}}
                {{#TemplateInjection}}
                <div class="container bg-info text-white" id="TemplateInjection">
                    <h2>Campo de texto enriquecido</h2>
                    <p>Estado: <span id="TemplateInjectionStatus">Pendiente</span></p>
                    <ul id="TemplateInjectionContext" style="padding-left: 5%"></ul>
                </div>
                {{/TemplateInjection}}
                {{#EntityRelations}}
                <div class="container bg-info text-white" id="EntityRelations">
                    <h2>Varias entidades relacionadas</h2>
                    <p>Estado: <span id="EntityRelationsStatus">Pendiente</span></p>
                    <ul id="EntityRelationsContext" style="padding-left: 5%"></ul>
                </div>
                {{/EntityRelations}}
                {{#DataBaseCommunication}}
                <div class="container bg-info text-white" id="DataBaseCommunication">
                    <h2>Comunicación con la base de datos</h2>
                    <p>Estado: <span id="DataBaseCommunicationStatus">Pendiente</span></p>
                    <ul id="DataBaseCommunicationContext" style="padding-left: 5%"></ul>
                </div>
                {{/DataBaseCommunication}}
            </div>

        </div>

        <script>
                var cytoscapeArray = ["graph_unauth", "graph_auth"];
                initializeCytoscape(cytoscapeArray, 0);
                initializeCytoscape(cytoscapeArray, 1);

                var trees = [new Map(), new Map()];
                $( document ).ready(function() {

                    var circlesIlluminated = 1;
                    update(circlesIlluminated);

                    $("#graph_auth").hide();
                    $("#accordion_auth").hide();

                    var source = new EventSource('https://localhost:8081/sse/{{scanID}}');

                    source.addEventListener('UrlRelation', function(event){
                        var data = JSON.parse(event.data);
                        var urlRelation = data["relation"];
                        var isAuthenticated = data["isAuthenticated"];
                        var cy = null;
                        var tree = null;
                        if(isAuthenticated){
                            cy = cytoscapeArray[1];
                            tree = trees[1];
                        } else {
                            cy = cytoscapeArray[0];
                            tree = trees[0];
                        }
                        addUrlToGraph(cy, urlRelation["initUrl"], "{{baseUrl}}");
                        addUrlToGraph(cy, urlRelation["endUrl"], "{{baseUrl}}");
                        addEdgeToGraph(cy, urlRelation, "{{baseUrl}}", tree);
                    });

                    source.addEventListener('Form', function(event){
                        var parsedForm = JSON.parse(event.data);
                        createFormInformation(parsedForm);
                    });

                    source.addEventListener('Vulnerability', function(event){
                        var vulnerability = JSON.parse(event.data);
                        console.log(vulnerability);
                        if(vulnerability["vulnerabilityType"].startsWith("XSS")){
                            addXSSVulnerability(vulnerability);
                        } else if(vulnerability["vulnerabilityType"].startsWith("SQLi")){
                            addSQLiVulnerability(vulnerability);
                        } else if(vulnerability["vulnerabilityType"].startsWith("CSRF")){
                            addCSRFVulnerability(vulnerability);
                        } else if(vulnerability["vulnerabilityType"].startsWith("NoSecureChannel")){
                            addNoSecureChannelVulnerability(vulnerability);
                        } else if(vulnerability["vulnerabilityType"].startsWith("ImproperErrorHandling")){
                            addImproperErrorHandlingVulnerability(vulnerability);
                        }

                    });

                    source.addEventListener('ResponseStatus', function(event){
                        var response = JSON.parse(event.data);
                        console.log(response);
                        updateVulnerabilityState(response);
                    });

                    source.addEventListener('Context', function(event){
                        var context = JSON.parse(event.data);
                        console.log(context);
                        addContext(context);
                    });

                    source.addEventListener('Requirement', function(event){
                        var requirement = JSON.parse(event.data);
                        console.log(requirement);
                        changeStatusRequirement(requirement);
                    });

                    source.addEventListener('Progress', function(event){
                        var message = event.data;
                        if(message === "Finish"){
                            source.close();
                            circlesIlluminated += 1;
                            update(circlesIlluminated);
                        } else if(message === "Unauth Scraping"){
                            changeOrientation(cytoscapeArray[0]);
                            circlesIlluminated += 1;
                            update(circlesIlluminated);
                        } else if(message === "Exploiting"){
                            circlesIlluminated += 1;
                            update(circlesIlluminated);
                        } else if(message === "Scan for stored vulns"){
                            circlesIlluminated += 1;
                            update(circlesIlluminated);
                        } else if(message === "Auth Scraping"){
                            changeOrientation(cytoscapeArray[1]);
                        } else if(message === "Authenticated"){
                            circlesIlluminated += 1;
                            update(circlesIlluminated);
                        }
                    });
                });
        </script>
    </body>
</html>