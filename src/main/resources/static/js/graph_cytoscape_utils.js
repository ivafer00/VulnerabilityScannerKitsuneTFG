var parseUrl = function(url, baseUrl){
    url = new URL(url);
    if(baseUrl === url.origin){
        return url.pathname;
    } else return url.href;
}

var graphContainsElement = function(cy, id){
    return cy.getElementById(id).length != 0;
}

var addUrlToGraph = function(cy, url, baseUrl){
    url = parseUrl(url, baseUrl);
    if(!graphContainsElement(cy, url)){
            cy.add({
        		data: { id: url}
        	});

        	cy.layout({
        	    name: 'cose',
        	    nodeDimensionsIncludeLabels: true
        	}).run();
//            cy.layout({
//            	    name: 'breadthfirst',
//            	    spacingFactor: 2.5,
//            	    directed: true
//            }).run();
    }
}

var existsPath = function(cy, target, source){
    target = cy.nodes('[id = "' + target + '"]');
    var successors = target.successors();
    for(var i=0; i<successors.length; i++){
        if(successors[i].id() === source) return true;
    }
    return false;
}

var addEdgeToGraph = function(cy, urlRelation, baseUrl, tree){
    var initUrl = urlRelation["initUrl"];
    var endUrl = urlRelation["endUrl"];
    var type = urlRelation["type"];
    initUrl = parseUrl(initUrl, baseUrl);
    endUrl = parseUrl(endUrl, baseUrl);
    if(graphContainsElement(cy, initUrl) && graphContainsElement(cy, endUrl) && !existsPath(cy, endUrl, initUrl)){
        var color = "";
        switch(type){
            case "FORM": color="red";  break;
            case "redirect": color="blue";  break;
            case "js": color="orange";  break;
            case "a":   color="black";  break;
            case "iframe": color="green";  break;
        }

        cy.add({
        	data:{
        		id: initUrl + " " + endUrl + " " + type,
        		source: initUrl,
        		target: endUrl,
        	}
        });

        cy.edges('[id = "' + initUrl + " " + endUrl + " " + type + '"]').style({'line-color': color, 'target-arrow-color': color});

    }
}

var initializeCytoscape = function(array, position){
    var id = array[position];
    array[position] = cytoscape(
		{
			container: document.getElementById(id),
			style: [
			{
	            selector: 'node',
	            style: {
	                shape: 'square',
	                'background-color': 'red',
	                'height': 40,
       				'width': 40,
       				'label': 'data(id)'
//	                content: 'data(id)',
//	                'text-valign': 'center',
//                    'text-halign': 'center'
	            }
        	}, {
				selector: 'edge',
				style: {
					'curve-style': 'bezier',
					'target-arrow-shape': 'triangle'
				}
			}
        	]
		}
	);
}

function showWebGraph(button){
    var thisId = "unauth";
    var otherId = "auth";

    var buttonAuth = document.getElementById(otherId);
    if(buttonAuth.className === "btn btn-primary active") buttonAuth.className = "btn btn-secondary";
    else buttonAuth.className = "btn btn-primary active";

    var buttonUnauth = document.getElementById(thisId);
    if(buttonUnauth.className === "btn btn-primary active") buttonUnauth.className = "btn btn-secondary";
    else buttonUnauth.className = "btn btn-primary active";

	if($("#graph_" + thisId).is(":visible")){
		$("#graph_" + thisId).hide()
	} else {
		$("#graph_" + thisId).show()
	}

	if($("#accordion_" + thisId).is(":visible")){
		$("#accordion_" + thisId).hide()
	} else {
		$("#accordion_" + thisId).show()
	}

	if($("#graph_" + otherId).is(":visible")){
		$("#graph_" + otherId).hide()
	} else {
		$("#graph_" + otherId).show()
	}

	if($("#accordion_" + otherId).is(":visible")){
		$("#accordion_" + otherId).hide()
	} else {
		$("#accordion_" + otherId).show()
	}
}

var changeOrientation = function(cy){
    cy.nodes().layout({
        name: 'preset',
        animate: false,
        fit: false,
        transform: (node) => {
            let position = {};
             position.x = node.position('y');
             position.y = node.position('x');
             return position;
        }
    }).run();
    cy.fit();
}