package es.urjc.Vulnerabilities.NoSecureChannel;

import es.urjc.Report.Vulnerabilities.NoSecureChannel.NoSecureChannelReport;
import es.urjc.Scanner.Security.WebScraper;
import es.urjc.WebElements.Form.Form;
import es.urjc.WebElements.ServerResponse;

public class NoSecureChannel {

    public NoSecureChannelReport detect(WebScraper webScraper){
        String baseUrl = webScraper.getProtocol() + webScraper.getBaseUrl();

        if(baseUrl.startsWith("http://")){
            NoSecureChannelReport secureChannelReport = new NoSecureChannelReport();
            secureChannelReport.addRequest(baseUrl);
            return secureChannelReport;
        } else {
            baseUrl = baseUrl.replaceFirst("https://", "http://");
            Form form = new Form(webScraper.getBaseUrl(), baseUrl, "GET");

            String request = form.getXHR();
            ServerResponse response = webScraper.sendXHR(request);
            System.out.println(response.getResponseText());
            if(response.isValidResponse()){
                NoSecureChannelReport secureChannelReport = new NoSecureChannelReport();
                secureChannelReport.addRequest(baseUrl);
                secureChannelReport.addResponse(response.getResponseText());
                return secureChannelReport;
            }
        }

        return null;
    }
}
